<div class="container-fluid">
  <div class="row">
    <div class="col-xl-12">
      <div class="card">
        <div class="card-body border-bottom">
          <div class="d-flex align-items-center">
            <h5 class="mb-0 card-title flex-grow-1">Solicitudes de Compra</h5>
            <div class="flex-shrink-0 d-flex gap-1">
              <a
                *ngIf="status === 2 && mostrarBoton"
                href="javascript:void(0);"
                class="btn btn-primary btn-sm"
                (click)="btnGenerarOC()"
                >Generar Orden de Compra</a
              >
              <a
                *ngIf="!solicitudSelecionada"
                href="javascript:void(0);"
                class="btn btn-primary btn-sm"
                (click)="openModal(content)"
                >Nuevo</a
              >
              <a
                *ngIf="solicitudSelecionada"
                href="javascript:void(0);"
                class="btn btn-dark btn-sm"
                (click)="regresar()"
                >Volver</a
              >
              <a
                *ngIf="
                  status === 1 && !comprasService.mostrarCotizacionSource.value
                "
                href="javascript:void(0);"
                class="btn btn-info btn-sm"
                (click)="mostrarCotizacion()"
                >Cotizar</a
              >
              <a
                *ngIf="
                  status >= 2 &&
                  status != 5 &&
                  !comprasService.mostrarCotizacionSource.value
                "
                href="javascript:void(0);"
                class="btn btn-danger btn-sm"
                (click)="cancelarSolicitud()"
                >Cancelar</a
              >
            </div>
          </div>
        </div>

        <div *ngIf="!solicitudSelecionada" class="card-body border-bottom">
          <div>
            <div class="d-flex justify-content-center" *ngIf="isLoad">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div class="tab-page-content mt-3">
              <table
                *ngIf="!isLoad"
                class="table table-striped table-hover table-sm table-bordered"
              >
                <thead class="table-light">
                  <tr>
                    <th>Folio</th>
                    <th>Empresa</th>
                    <th>Solicita</th>
                    <th>Usuario Destino</th>
                    <th>Fecha Solicitud</th>
                    <th>Estatus</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let item of data"
                    (dblclick)="openModal1(item, $event)"
                  >
                    <td>{{ item.folio }}</td>
                    <td>CAS</td>
                    <td>{{ item.usuario_solicita }}</td>
                    <td>{{ item.usuario_destino }}</td>
                    <td>{{ item.fecha }}</td>
                    <td>
                      <div class="text-center">
                        <span
                          [ngClass]="
                            'badge rounded-pill font-size-11 ' +
                            item.claseEstado
                          "
                        >
                          {{ item.estado }}
                        </span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <app-detalles-solicitud-compra
          [solicitudCompra]="solicitudCompra"
          *ngIf="solicitudSelecionada"
        ></app-detalles-solicitud-compra>
        <!-- <app-cotizaciones [solicitudCompra]="solicitudCompra" *ngIf="solicitudSelecionada"></app-cotizaciones> -->
        <!--div.card-body-->
      </div>
    </div>
  </div>
</div>
<!-- container-fluid -->

<!-- Order Create Model -->
<ng-template #content role="document" let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="exampleModalLabel">
      Nueva Requisici贸n de Compra
    </h5>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="modal"
      aria-label="Close"
      id="close-modal"
      (click)="modalRef?.hide()"
    ></button>
  </div>
  <div class="modal-body">
    <form class="row g-2" [formGroup]="formSolicitudCompra">
      <div class="col-md-6">
        <label for="usuario" class="form-label form-label-sm"
          >Empresas: *</label
        >
        <select
          class="form-select form-select-sm"
          aria-label="Default select example"
          formControlName="usuario"
          id="usuario"
          name="usuario"
          aria-label="usuario"
        >
          <option selected>Selecciona uno</option>
          <option value="1">Empresa 1</option>
          <option value="2">Empresa 2</option>
          <option value="3">Empresa 3</option>
        </select>
        <div
          *ngIf="
            solicitudCompraFormControl.usuario.touched ||
            submitted ||
            solicitudCompraFormControl.usuario.value === 'Selecciona uno'
          "
        >
          <div
            class="text-danger form-text"
            *ngIf="solicitudCompraFormControl.usuario.errors?.['required']"
          >
            usuario es requerido.
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <label for="usuario_destino" class="form-label">Usuarios: *</label>
        <select
          class="form-select form-select-sm"
          aria-label="Default select example"
          formControlName="usuario_destino"
          id="usuario_destino"
          name="usuario_destino"
          aria-label="usuario_destino"
        >
          <option selected>Selecciona uno</option>
          <option value="1">Usuario 1</option>
          <option value="2">Usuario 2</option>
          <option value="3">Usuario 3</option>
        </select>
        <div
          *ngIf="
            solicitudCompraFormControl.usuario_destino.touched || submitted
          "
        >
          <div
            class="text-danger form-text"
            *ngIf="solicitudCompraFormControl.usuario_destino.errors?.['required']"
          >
            Usuarios es requerido.
          </div>
        </div>
      </div>

      <div class="col-md-12">
        <label for="motivo" class="form-label">Motivo de la compra: *</label>
        <textarea
          class="form-control"
          formControlName="motivo"
          id="motivo"
          name="motivo"
          rows="3"
        ></textarea>

        <div *ngIf="solicitudCompraFormControl.motivo.touched || submitted">
          <div
            class="text-danger form-text"
            *ngIf="solicitudCompraFormControl.motivo.errors?.['required']"
          >
            motivo es requerido.
          </div>
        </div>
      </div>
      <!-- fin primer from -->
    </form>
    <hr />
    <h5 class="mb-0 card-title flex-grow-1">Detalle de la Solicitud</h5>
    <form [formGroup]="formDetalleSolicitud" enctype="multipart/form-data">
      <div class="row align-items-center">
        <div class="col-sm-2 my-1">
          <label class="sr-only" for="inlineFormInputName">cantidad</label>
          <input
            min="1"
            type="number"
            formControlName="cantidad"
            id="cantidad"
            name="cantidad"
            aria-label="cantidad"
            class="form-control form-control-sm"
            size="4"
            placeholder="Cantidad"
          />
          <div
            *ngIf="
              detalleSolicitudFormControl.cantidad.touched || submittedDetail
            "
          >
            <div
              class="text-danger form-text"
              *ngIf="detalleSolicitudFormControl.cantidad.errors?.['required']"
            >
              Cantidad es requerido.
            </div>
          </div>
        </div>
        <div class="col-sm-2 my-1">
          <select
            class="form-select form-select-sm"
            type="text"
            formControlName="cat_unidades_medida_id"
            #selectElement
            (change)="onChange(selectElement)"
            id="cat_unidades_medida_id"
            name="cat_unidades_medida_id"
            aria-label="cat_unidades_medida_id"
          >
            <option selected>Selecciona una unidad</option>
            <option *ngFor="let item of unidades" value="{{ item.id }}">
              {{ item.nombre }} ({{ item.abreviatura }})
            </option>
          </select>
          <div
            *ngIf="
              detalleSolicitudFormControl.cat_unidades_medida_id.touched ||
              submittedDetail
            "
          >
            <div
              class="text-danger form-text"
              *ngIf="detalleSolicitudFormControl.cat_unidades_medida_id.errors?.['required']"
            >
              Unidad es requerido.
            </div>
          </div>
        </div>
        <div class="col-sm-4 my-1">
          <input
            type="text"
            formControlName="descripcion"
            id="descripcion"
            name="descripcion"
            aria-label="descripcion"
            class="form-control form-control-sm"
            size=""
            placeholder="Descripci贸n"
          />
          <div
            *ngIf="
              detalleSolicitudFormControl.descripcion.touched || submittedDetail
            "
          >
            <div
              class="text-danger form-text"
              *ngIf="detalleSolicitudFormControl.descripcion.errors?.['required']"
            >
              Descripci贸n es requerido.
            </div>
          </div>
        </div>
        <div class="col-sm-4 my-1">
          <input
            type="text"
            formControlName="observaciones"
            id="observaciones"
            name="observaciones"
            aria-label="observaciones"
            class="form-control form-control-sm"
            size=""
            placeholder="Observaciones"
          />
          <div
            *ngIf="
              detalleSolicitudFormControl.observaciones.touched ||
              submittedDetail
            "
          >
            <div
              class="text-danger form-text"
              *ngIf="detalleSolicitudFormControl.observaciones.errors?.['required']"
            >
              Observaciones es requerido.
            </div>
          </div>
        </div>

        <div class="col-sm-10 my-1">
          <label for="img_referencia" class="form-label"
            >Referencia fotografica:
          </label>
          <input
            type="file"
            id="img_referencia"
            name="img_referencia"
            aria-label="img_referencia"
            class="form-control form-control-sm"
            (change)="onFileChange($event, 'img_referencia')"
            formControlName="img_referencia"
          />
          <div
            *ngIf="
              detalleSolicitudFormControl.img_referencia.touched ||
              submittedDetail
            "
          >
            <div
              class="text-danger form-text"
              *ngIf="detalleSolicitudFormControl.img_referencia.errors?.['required']"
            >
              Imagen de referencia es requerido.
            </div>
          </div>
        </div>
        <div class="col-auto my-1">
          <button
            type="submit"
            class="btn btn-primary btn-sm float-end"
            (click)="addDetalle()"
          >
            Agregar
          </button>
        </div>
      </div>
    </form>
    <br />
    <table
      class="table table-striped table-hover table-sm table-bordered"
      id="tableCompraInsumos"
    >
      <thead class="table-light">
        <tr>
          <th>Cantidad</th>
          <th>Unidad de Medida</th>
          <th>Descripci贸n</th>
          <th>Observaciones</th>
          <th>Imagen</th>
        </tr>
      </thead>
      <tbody>
        <!-- datos de la tabla detalle -->
        <tr *ngFor="let row of tableData; let i = index">
          <td>{{ row.cantidad }}</td>
          <td>{{ row.cat_unidades_medida_id1 }}</td>
          <td>{{ row.descripcion }}</td>
          <td>{{ row.observaciones }}</td>
          <td>
            <img
              src="{{ row.img_referencia1 }}"
              alt="Sin imagen de referencia"
              width="100"
            />
          </td>
          <td>
            <button
              type="button"
              class="btn btn-danger btn-sm"
              (click)="removeDetalle(i)"
            >
              Quitar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-secondary btn-sm"
      data-bs-dismiss="modal"
      (click)="modalRef?.hide()"
    >
      Cerrar
    </button>
    <button type="button" class="btn btn-primary btn-sm" (click)="save()">
      Guardar
    </button>
  </div>
</ng-template>
<!--End Modal -->
